---
/**
 * Mods Directory Page - /mods
 * Displays all mods with filtering and search
 */
import BaseLayout from "../../layouts/BaseLayout.astro";
import ModCard from "../../components/ModCard.astro";
import { mods, getAllTags, statusConfig } from "../../data/mods";

const allTags = getAllTags();
---

<BaseLayout title="All Mods" description="Browse the complete collection of mods for Upload Labs. Quality-of-life enhancements, visual tweaks, and powerful tools.">
  <!-- Header -->
  <section class="bg-gradient-to-b from-dark-900 to-dark-950 text-white py-16 md:py-20">
    <div class="container-wide text-center">
      <h1 class="text-4xl md:text-5xl font-bold mb-4">All Mods</h1>
      <p class="text-xl text-gray-300 max-w-2xl mx-auto">
        Browse the complete collection of mods for Upload Labs
      </p>
    </div>
  </section>

  <!-- Filters and Mods -->
  <section class="section bg-gray-50 dark:bg-dark-950">
    <div class="container-wide">
      <!-- Search and Filters -->
      <div class="mb-8 space-y-4">
        <!-- Search -->
        <div class="relative max-w-md">
          <input 
            type="text" 
            id="mod-search"
            placeholder="Search mods..."
            class="w-full px-4 py-3 pl-10 rounded-lg border border-gray-200 dark:border-dark-700 bg-white dark:bg-dark-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-accent-500 focus:border-transparent"
          />
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>

        <!-- Filter Tags -->
        <div class="flex flex-wrap gap-2 items-center">
          <span class="text-sm text-gray-500 dark:text-gray-400 mr-2">Filter:</span>
          <button 
            data-filter="all" 
            class="filter-btn chip-active"
          >
            All
          </button>
          {allTags.map(tag => (
            <button 
              data-filter={tag} 
              class="filter-btn chip"
            >
              {tag}
            </button>
          ))}
        </div>

        <!-- Sort -->
        <div class="flex items-center gap-3">
          <span class="text-sm text-gray-500 dark:text-gray-400">Sort by:</span>
          <select 
            id="mod-sort"
            class="px-3 py-2 rounded-lg border border-gray-200 dark:border-dark-700 bg-white dark:bg-dark-800 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-accent-500"
          >
            <option value="name">Name (A-Z)</option>
            <option value="updated">Recently Updated</option>
            <option value="status">Status</option>
          </select>
        </div>
      </div>

      <!-- Mods Grid -->
      <div id="mods-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {mods.map(mod => (
          <div 
            class="mod-item" 
            data-name={mod.name.toLowerCase()}
            data-description={mod.shortDescription.toLowerCase()}
            data-tags={mod.tags.join(',').toLowerCase()}
            data-status={mod.status}
            data-updated={mod.updatedAt || ''}
          >
            <ModCard mod={mod} />
          </div>
        ))}
      </div>

      <!-- Empty State -->
      <div id="empty-state" class="hidden text-center py-16">
        <div class="text-5xl mb-4">üîç</div>
        <h3 class="text-xl font-semibold mb-2">No mods found</h3>
        <p class="text-gray-500 dark:text-gray-400">
          Try adjusting your search or filter criteria
        </p>
        <button 
          id="clear-filters"
          class="btn-secondary mt-4"
        >
          Clear Filters
        </button>
      </div>

      <!-- Stats -->
      <div class="mt-8 text-center text-sm text-gray-500 dark:text-gray-400">
        <span id="mod-count">{mods.length}</span> mod(s) available
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  function initModsFilter() {
    // Prevent duplicate initialization
    if ((window as any).__modsFilterInitialized) return;
    (window as any).__modsFilterInitialized = true;

    const searchInput = document.getElementById('mod-search') as HTMLInputElement;
    const sortSelect = document.getElementById('mod-sort') as HTMLSelectElement;
    const filterBtns = document.querySelectorAll('.filter-btn');
    const modsGrid = document.getElementById('mods-grid');
    const emptyState = document.getElementById('empty-state');
    const modCount = document.getElementById('mod-count');
    const clearFiltersBtn = document.getElementById('clear-filters');

    // Parse URL parameters for initial filter
    const urlParams = new URLSearchParams(window.location.search);
    const initialFilter = urlParams.get('filter') || 'all';
    
    let currentFilter = initialFilter;
    let currentSearch = '';

    // Apply initial filter button state
    filterBtns.forEach(btn => {
      const filterValue = btn.getAttribute('data-filter') || 'all';
      btn.className = filterValue === currentFilter ? 'filter-btn chip-active' : 'filter-btn chip';
    });

    function filterAndSort() {
      if (!modsGrid) return;

      const items = Array.from(modsGrid.querySelectorAll('.mod-item')) as HTMLElement[];
      let visibleCount = 0;

      items.forEach(item => {
        const name = item.dataset.name || '';
        const description = item.dataset.description || '';
        const tags = item.dataset.tags || '';
        
        // Check search match
        const searchMatch = currentSearch === '' || 
          name.includes(currentSearch) || 
          description.includes(currentSearch) ||
          tags.includes(currentSearch);

        // Check filter match
        const filterMatch = currentFilter === 'all' || 
          tags.includes(currentFilter.toLowerCase());

        if (searchMatch && filterMatch) {
          item.classList.remove('hidden');
          visibleCount++;
        } else {
          item.classList.add('hidden');
        }
      });

      // Sort visible items
      const sortBy = sortSelect?.value || 'name';
      const sortedItems = items
        .filter(item => !item.classList.contains('hidden'))
        .sort((a, b) => {
          switch (sortBy) {
            case 'name':
              return (a.dataset.name || '').localeCompare(b.dataset.name || '');
            case 'updated':
              return (b.dataset.updated || '').localeCompare(a.dataset.updated || '');
            case 'status':
              const statusOrder: Record<string, number> = { stable: 0, beta: 1, wip: 2 };
              return (statusOrder[a.dataset.status || 'wip'] || 2) - (statusOrder[b.dataset.status || 'wip'] || 2);
            default:
              return 0;
          }
        });

      // Reorder DOM
      sortedItems.forEach(item => modsGrid.appendChild(item));

      // Update UI
      if (modCount) modCount.textContent = String(visibleCount);
      if (emptyState) {
        emptyState.classList.toggle('hidden', visibleCount > 0);
      }
      if (modsGrid) {
        modsGrid.classList.toggle('hidden', visibleCount === 0);
      }
    }

    function clearFilters() {
      currentFilter = 'all';
      currentSearch = '';
      if (searchInput) searchInput.value = '';
      
      filterBtns.forEach(btn => {
        const isAll = btn.getAttribute('data-filter') === 'all';
        btn.className = isAll ? 'filter-btn chip-active' : 'filter-btn chip';
      });

      filterAndSort();
    }

    // Event listeners
    searchInput?.addEventListener('input', (e) => {
      currentSearch = (e.target as HTMLInputElement).value.toLowerCase();
      filterAndSort();
    });

    sortSelect?.addEventListener('change', filterAndSort);

    filterBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        currentFilter = btn.getAttribute('data-filter') || 'all';
        
        filterBtns.forEach(b => {
          b.className = b === btn ? 'filter-btn chip-active' : 'filter-btn chip';
        });

        filterAndSort();
      });
    });

    clearFiltersBtn?.addEventListener('click', clearFilters);

    // Initial sort
    filterAndSort();
  }

  // Reset flag on page navigation for View Transitions
  document.addEventListener('astro:before-swap', () => {
    (window as any).__modsFilterInitialized = false;
  });

  // Initialize on page load and navigation
  document.addEventListener('astro:page-load', initModsFilter);
  initModsFilter();
</script>
